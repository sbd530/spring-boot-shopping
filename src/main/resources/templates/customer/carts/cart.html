<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      class="wf-ebgaramond-n4-active wf-ptserif-n4-active wf-nanumgothic-n4-active wf-nanummyeongjo-n6-active wf-nanummyeongjo-n4-active wf-active">
<meta http-equiv="X-UA-Compatible" id="X-UA-Compatible" content="IE=edge">
<!-- header -->
<header th:insert="customer/main/header.html"></header>

<div th:replace="customer/users/mypage/head"></div>


<script th:inline="javascript">
$(function () {

  $(".plusAmount").on("click", function() {
    let productId = $(this).parent().find(".productId").val();
    let newOrderAmount = parseInt($(this).parent().find(".orderAmount").val())+1;
    if(newOrderAmount>$(".stock" + productId).val()) {
      alert("재고가 부족합니다!");
      return;
    }
    $(this).parent().find(".orderAmount").val(newOrderAmount);

    let formData = new FormData();
    formData.append("productId", productId);
    formData.append("orderAmount", newOrderAmount);

    $.ajax({
      url: '/carts',
      data: formData,
      processData: false,
      contentType: false,
      type: 'PUT'
    });
  })

  $(".minusAmount").on("click", function() {
    let productId = $(this).parent().find(".productId").val();
    let newOrderAmount = parseInt($(this).parent().find(".orderAmount").val()) - 1;
    if(newOrderAmount<1) {
      alert("1개 이상만 가능합니다.");
      return;
    }
    $(this).parent().find(".orderAmount").val(newOrderAmount);

    let formData = new FormData();
    formData.append("productId", productId);
    formData.append("orderAmount", newOrderAmount);

    $.ajax({
      url: '/carts',
      data: formData,
      processData: false,
      contentType: false,
      type: 'PUT'
    });
  })

  <!-- 장바구니 삭제요청 -->
  $("#removeCartItemBtn").on("click", function() {
    let productId = $(this).parent().find(".productId").val();
    $.ajax({
      url: "/carts?productId=${productId}",
      type: "DELETE",
      success: function(data) {
        location.reload();
      }
    });
  });

  <!-- form 생성 -->
  $("btn_orderProducts").on("click", function() {
    let form = $("<form action='/orders' method='post' style='display:none'></form>");
    $("body").append(form);

    from.submit();
  });
});
</script>


<!--function plusAmount(productId){

    var oldValue = $("#orderAmount"+productId).val();
    $("#orderAmount"+productId).val(oldValue+1);

    var url = "/carts"

    $.ajax({
        url: url,
        method: "PUT",
        data: {
            productId: productId,
            orderAmount: $("#orderAmount"+productId).val()

        },
        success: function(data){
            alert(data);
        },
        error: function(){
            alert("에러발생");
        }
    });
}-->

<body>
<div id="displayCanvas" class="desktop" data-viewport="desktop">
  <div id="shopCartDetail" class="shopCartDetail wrapper">
    <div id="cart" class="cart wrapper clearfix">
      <div class="header designSettingElement text-titleWithFontSize">
        <span class="title">
          장바구니
          <span id="cartSize">
          </span>
        </span>
      </div>

      <div class="product field designSettingElement text-body shopCartInfo">
        <div class="tb-title designSettingElement shape">
          <div class="item-list-header">
            <span style="width:31%;">상품 정보</span>
            <span style="width:8%;">가격</span>
            <span style="width:40%;text-align:center;">수량</span>
            <span style=" text-align: center;padding-left:110px;">삭제</span>
          </div>
        </div>
        <div id="cartListDiv" class="tb-content with-delivery-price">
          <div class="delivery-group-item-list">

            <!-- CartLine Row Start @Don -->
            <div th:each="cartLine : ${cartLineDtoList}" class="info cartDiv designSettingElement shape" style="display:inline-block">
              <div class="product" style="display:inline-block;width:620px;">
                <div class="img" style="display:inline-block">
                  <a th:href="@{'/products/' + ${cartLine.productId}}">
                    <img th:src="@{/products/}+${cartLine.productId} + @{/images/THUMBNAIL1}" style="width:80px;height:80px;">
                  </a>
                </div>
                <div class="text" style="display:inline-block">
                  <div class="name" style="display:inline-block;width:230px;">
                    <a th:href="@{'/products/' + ${cartLine.productId}}" th:text="${cartLine.productName}">
                      <!-- productName -->
                    </a>
                  </div>
                  <div class="delete-btn-wrapper" style="display:inline-block">
                    <div th:if="${cartLine.rprice==cartLine.dprice}" th:text="${#numbers.formatInteger(cartLine.rprice, 3, 'COMMA') + '원'}"></div>
                    <div th:unless="${cartLine.rprice==cartLine.dprice}" th:text="${#numbers.formatInteger(cartLine.dprice, 3, 'COMMA') + '원'}"></div>
                  </div>
                </div>
              </div>
              <div class="QuantityDiv" style="display:inline-block;padding-left:0;width:120px;">
                  <span class="ui-spinner ui-corner-all ui-widget ui-widget-content">
                    <!-- productId를 가져오기 위한 필드 -->
                    <input class="productId" type="text" style="display: none;" th:value="${cartLine.productId}" th:name="productId">

                    <!-- 상품 수량 -->
                    <input type="hidden" name="stock" th:class="'stock'+${cartLine.productId}" th:value="${cartLine.stock}">
                    <button tabindex="-1" aria-hidden="true" class="ui-button ui-widget ui-spinner-button ui-spinner-up ui-corner-tr ui-button-icon-only minusAmount" role="button"
                            type="button">-</button>
                    <input th:value="${cartLine.orderAmount}"
                           class="designSettingElement shape ui-spinner-input orderAmount" th:min="1" th:max="${cartLine.stock}"
                           type="number">
                    <button tabindex="-1" aria-hidden="true" class="ui-button ui-widget ui-spinner-button ui-spinner-down ui-corner-br ui-button-icon-only plusAmount" role="button"
                            type="button">+</button>
                  </span>
              </div>
              <div class="QuantityDiv" style="display:inline-block">
                <div class="delete-btn-wrapper" style="display:inline-block">
                  <!-- productId를 가져오기 위한 필드 -->
                  <input class="productId" type="text" style="display: none;" th:value="${cartLine.productId}" th:name="productId">
                  <button id="removeCartItemBtn" type="button">
                    삭제하기
                  </button>
                </div>
              </div>
            </div>
            <!-- CartLine Row 끝 -->


          </div>


          <div class="delivery-group-delivery-price-wrapper designSettingElement shape">

            <div class="delivery-group-sale-price-info">
              <div class="delivery-group-sale-price">

              </div>
            </div>

            <div class="delivery-group-delivery-price-info">

            </div>
          </div>
        </div>

        <div class="tb-total clearfix">
          <div id="cartInfoDiv" class="info designSettingElement shape">
            <div class="price">
              <div class="title">상품 수량</div>
              <div id="cartTotalProductPrice" class="content">[[${totalAmount}]] 개</div>
            </div>
            <div id="cartDiscountDiv" class="discount">
              <div class="hide">
                <span class="icomoon-ic-info designSettingElement text-assi"></span>
                <span id="cartDiscountList" class=""></span>
              </div>
            </div>
            <div class="price shippingPriceWrapper">
              <div class="title">배송비</div>
              <div id="cartTotalDeliveryPrice" class="content">무료</div>
            </div>
          </div>
          <div id="cartTotalDiv" class="total">
            <div class="title bold">합 계</div>
            <div id="cartTotalDiscountAppliedPrice" class="content bold">[[${#numbers.formatInteger(totalPrice, 3, 'COMMA')}]]원</div>
          </div>
        </div>
      </div>

      <div class="btn-wrapper shopCartInfo">
        <button id="btn_orderProducts" class="designSettingElement button" style="background-color: #2B2F33 !important;">주문하기</button>
      </div>

      <div th:if="${#lists.size(cartLineDtoList)==0}" id="no-shopCart-msg" class="field_content no-content-msg designSettingElement text-body">
        장바구니가 비어 있습니다.
      </div>


    </div>
  </div>

</div>
</body>
</html>